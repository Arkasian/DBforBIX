<parms type="oracle" prefix="oracle.">
	<server>
		<discovery time="120" item="discovery.DB4bix.config[instanceid,{$DSN}]" names="INST_ID">select inst_id from gv$instance</discovery>
        <query time="60" item="stats[%1,%2]">
		SELECT inst_id, REPLACE(name,' ','_'), value FROM gv$sysstat WHERE name IN ('user I/O wait time','physical read total bytes','physical write total bytes','lob reads','lob writes','db block changes','db block gets','consistent gets','physical reads','physical reads direct','physical writes direct','redo writes','physical read requests optimized','physical write requests optimized')
		</query>
		<query time="60" item="stats[%1,%2]">
		select inst_id,'dbhitratio',trunc((sum(decode(name,'consistent gets', value,0)) + sum(decode(name,'db block gets', value,0)) - sum(decode(name,'physical reads', value,0))) / (sum(decode(name,'consistent gets', value,0)) + sum(decode(name,'db block gets', value,0)) ) * 100,2) "hit_ratio" FROM gv$sysstat group by inst_id
		</query>
		
	    <query time="900" item="parameter[%1,%2]">SELECT inst_id,name,value FROM gv$parameter WHERE name IN ('processes','sessions','sga_max_size','memory_target','memory_max_target','shared_pool_reserved_size','db_block_size','log_buffer','db_files','parallel_server_instances','cluster_database_instances','db_flashback_retention_target','distributed_lock_timeout','create_bitmap_area_size','bitmap_merge_area_size','hash_area_size','sort_area_size','pga_aggregate_target','pga_aggregate_limit')</query>
		
		
		
		<query time="60" item="sgastat[%1,%2]">
			SELECT inst_id,decode(nvl(pool,'none'),
			'shared pool','pool_sql_area',
			'none','sga_bufcache',
			'java pool','java_pool',
			'large pool','large_pool'
			),
			SUM(bytes) bytes
			FROM GV$SGASTAT 
			where (nvl(pool,'none'),name) in (
			('shared pool','sql area'),
			('shared pool','SQLA'),
			('none','db_block_buffers'),
			('none','buffer_cache')
			) or pool in ('java pool','large pool')
			group by inst_id, 
			nvl(pool,'none')
		</query>		
		<query time="60" item="sgastat[%1,%2]">
			SELECT inst_id, name, sum(bytes) bytes
			FROM GV$SGASTAT 
			where pool is null
			and name in ('fixed_sga','log_buffer')
			group by inst_id, name
		</query>
		<query time="60" item="sgastat[%1,%2]">
			SELECT inst_id, 'pool_misc',sum(bytes) bytes
			FROM GV$SGASTAT 
			where pool in ('shared pool') and 
			name not in ('library cache','dictionary cache','free memory','sql area','SQLA')
			group by inst_id
		</query>
		<query time="60" item="sgastat[%1,%2]">
			SELECT inst_id, REPLACE(name,' ','_'),sum(bytes) bytes
			FROM GV$SGASTAT 
			where pool in ('shared pool') and 
			name in ('dictionary cache','free memory','library cache','sql area','SQLA')
			group by inst_id, name
		</query>
		

		<query time="60" item="uptime[%1]" nodata="0">SELECT inst_id, ROUND((sysdate-startup_time)*86400) retvalue FROM gv$instance</query>		
		<query time="60" item="procnum[%1]">SELECT inst_id,COUNT(*) procnum from gv$process group by inst_id</query>
		<query time="120" item="miss_latch[%1]">SELECT inst_id,SUM(misses) FROM GV$LATCH group by inst_id</query>
		<query time="120" item="sessions[%1]" nodata="0">SELECT inst_id, COUNT(*) FROM gv$session group by inst_id</query>
		<query time="120" item="session_system[%1]" nodata="0">SELECT inst_id, COUNT(*) FROM gv$session WHERE type='BACKGROUND' group by inst_id</query>
		<query time="120" item="session_active[%1]" nodata="0">SELECT inst_id, COUNT(*) FROM gv$session WHERE type!='BACKGROUND' AND status='ACTIVE' group by inst_id</query>
		<query time="120" item="users_connected[%1]" nodata="0">
		SELECT inst_id, count(username) FROM gv$session WHERE username is not null group by inst_id		
		</query>
		<query time="600" item="dbfilesize">SELECT SUM(NVL(bytes,0)) val FROM dba_data_files</query>
		<query time="600" item="dbsize">
			SELECT SUM(NVL(a.bytes, 0) - NVL(f.bytes, 0)) val FROM sys.dba_tablespaces d, 
			(SELECT tablespace_name, SUM(bytes) bytes FROM dba_data_files GROUP BY tablespace_name) a, 
			(SELECT tablespace_name, SUM(bytes) bytes FROM dba_free_space GROUP BY tablespace_name) f 
			WHERE d.tablespace_name = a.tablespace_name(+)
				AND d.tablespace_name = f.tablespace_name(+) 
				AND NOT (
					d.extent_management LIKE 'LOCAL'
					AND d.contents LIKE 'TEMPORARY'
				)
		</query>
		<query time="600" item="session_io_log" nodata="none">
		select LISTAGG(sessions_tab,chr(10)) WITHIN GROUP(ORDER BY PCT desc) sessions from (
      select INST_ID||': '||'PCT[R/W/T,MB/s]='||PCT||'['||SESSION_IO_R_MBps||'/'||SESSION_IO_W_MBps||'/'||TOTAL_IO_MBps||'];SQL_(ID/FULL_PLAN_HV)='||SQL_ID||'/'||sql_full_plan_hash_value||';SID='||sid||'#'||SERIAL#||';(SCH/USER)NAME='||SCHEMANAME||'/'||USERNAME||';STATUS='||STATUS||';TYPE='||TYPE||';OSUSER='||OSUSER||';PROGRAM='||REGEXP_REPLACE(PROGRAM,'@.*$','')||'@'||MACHINE||';PROCESS='||PROCESS||';'||DESCRIPTION sessions_tab, PCT 
      from (
        select b.inst_id,b.sid,b.SERIAL#,b.SCHEMANAME,b.OSUSER,b.USERNAME,b.STATUS,b.SQL_ID,b.PROCESS,b.PROGRAM,b.MACHINE,b.TYPE,
          round(100*(sio.SESSION_IO_R+sio.SESSION_IO_W)/fio.TOTAL_IO,2) PCT,round(sio.SESSION_IO_R,2) SESSION_IO_R_MBps,
          round(sio.SESSION_IO_W,2) SESSION_IO_W_MBps,round(fio.TOTAL_IO, 2) TOTAL_IO_MBps,p.DESCRIPTION, sio.sql_full_plan_hash_value 
        from gv$session b, gv$bgprocess p, (
          select inst_id, sum(((DELTA_READ_IO_BYTES/1024/1024)+(DELTA_WRITE_IO_BYTES/1024/1024))/(DELTA_TIME/1000000))/600 total_io 
          from GV$ACTIVE_SESSION_HISTORY where sample_time &gt; sysdate-10/24/60 
          group by inst_id
        ) fio,(
          select inst_id, session_id,sum((DELTA_READ_IO_BYTES/1024/1024)/(DELTA_TIME/1000000))/600 session_io_r, sum((DELTA_WRITE_IO_BYTES/1024/1024)/(DELTA_TIME/1000000))/600 session_io_w, sql_full_plan_hash_value 
          from GV$ACTIVE_SESSION_HISTORY 
          where sample_time &gt; sysdate-10/24/60
          group by inst_id, session_id, sql_full_plan_hash_value
        ) sio 
        where p.paddr(+) = b.paddr and p.inst_id(+)=b.inst_id 
              and sio.session_id = b.sid and sio.inst_id=b.inst_id 
              and fio.inst_id=b.inst_id
        order by PCT desc nulls last
    ) where rownum &lt; 11)
	</query>
	
	
	<query time="600" item="archivelog_size[%1]" nodata="0"> 
	select A.inst_id, round(A.LOGS*B.AVG/10) 
	from ( 
			SELECT inst_id, COUNT (*)  LOGS 
			FROM GV$LOG_HISTORY 
			WHERE FIRST_TIME &gt;= (sysdate -10/60/24)
			group by inst_id
		) A, ( 
			SELECT inst_id, Avg(BYTES) AVG,  Count(1), Max(BYTES) Max_Bytes, Min(BYTES) Min_Bytes  
			FROM  gv$log 
			group by inst_id
		) B
	where A.inst_id=B.inst_id
	</query>

    <query time="120" item="db_locks" nodata="none">
		select SUBSTR( sessions,1,2040)session_cut 
		from (select LISTAGG(sessions_tab, chr(10)) WITHIN GROUP (ORDER BY sessions_tab desc) sessions 
		  from (
			select blocking_sessions.inst_id||':'||chr(9)||
			'OBJ: '||o.owner || '.' ||o.object_name ||chr(10)||chr(9)||chr(9)||
			'BG: SID=' || blocking_sessions.sid ||'/'||blocking_sessions.serial#||'|'||blocking_sessions.status || 
			'|USER/SCHEMA=' ||blocking_sessions.username||'/'||blocking_sessions.schemaname || 
			'|OSUSER=' ||blocking_sessions.osuser || 
			'|' ||REGEXP_REPLACE(blocking_sessions.program,'@.*$','') || '@' ||blocking_sessions.machine || 
			'|' ||blocking_sessions.sql_id ||chr(10)||chr(9)||chr(9)||
			'BD: SID=' || 
			blocked_sessions.sid ||'/' || blocked_sessions.serial#||'|'||blocked_sessions.status || 
			'|USER/SCHEMA=' ||blocked_sessions.username||'/'||blocked_sessions.schemaname ||
			'|OSUSER=' ||blocked_sessions.osuser || 
			'|' ||REGEXP_REPLACE(blocked_sessions.program,'@.*','')||'@'||blocked_sessions.machine || 
			'|' ||blocked_sessions.sql_id sessions_tab 
			from (
			  select inst_id,sid,serial#,status,username,schemaname,osuser,machine,program,blocking_session,final_blocking_session,
			  row_wait_obj# blocked_objects,sql_id 
			  from gv$session 
			  where event like 'enq:%' and final_blocking_session_status = 'VALID'
			) blocked_sessions,
			gv$session blocking_sessions,
			dba_objects o 
			where 
			blocking_sessions.inst_id=blocked_sessions.inst_id and 
			blocking_sessions.sid = blocked_sessions.final_blocking_session and 
			o.object_id = blocked_sessions.blocked_objects        
		  ) where rownum &lt; 11
	  )
	</query>

    <query time="120" item="db_pga[%1]" nodata="0">
		select inst_id, value from GV$PGASTAT where name in 'total PGA inuse'
	</query>

	<multiquery time="120" items="dbwaits_latch[%1]|dbwaits_logwrite[%1]|dbwaits_file_io[%1]|waits_directpath_read[%1]|dbwaits_multiblock_read[%1]|dbwaits_other[%1]|dbwaits_singleblock_read[%1]|dbwaits_sqlnet[%1]" nodata="0" type="column">
	SELECT inst_id, 
	to_char(sum(decode(event,'control file sequential read', total_waits,'control file single write', total_waits, 'control file parallel write',total_waits,0))) ControlFileIO,
	to_char(sum(decode(event,'log file single write',total_waits, 'log file parallel write',total_waits,0))) LogWrite,
	to_char(sum(decode(event,'file identify',total_waits, 'file open',total_waits,0))) FileIO,
	to_char(sum(decode(event,'direct path read',total_waits,0))) DirectPathRead,
	to_char(sum(decode(event,'db file scattered read',total_waits,0))) MultiBlockRead,
	to_char(sum(decode(event,'control file sequential read',0,'control file single write',0,'control file parallel write',0,'db file sequential read',0,'db file scattered read',0,'direct path read',0,'file identify',0,'file open',0,'SQL*Net message to client',0,'SQL*Net message to dblink',0, 'SQL*Net more data to client',0,'SQL*Net more data to dblink',0, 'SQL*Net break/reset to client',0,'SQL*Net break/reset to dblink',0, 'log file single write',0,'log file parallel write',0,total_waits))) Other,
	to_char(sum(decode(event,'db file sequential read',total_waits,0))) SingleBlockRead,
	to_char(sum(decode(event,'SQL*Net message to client',total_waits,'SQL*Net message to dblink',total_waits,'SQL*Net more data to client',total_waits,'SQL*Net more data to dblink',total_waits,'SQL*Net break/reset to client',total_waits,'SQL*Net break/reset to dblink',total_waits,0))) SQLNET
	FROM GV$system_event WHERE event not in ('SQL*Net message from client','SQL*Net more data from client','pmon timer', 'rdbms ipc message','rdbms ipc reply', 'smon timer')  group by inst_id
	</multiquery>

	<query time="60" item="zabbix[%1,%2]" nodata="none">
	select inst_id,'activesessions', count(*) activeSessions from gv$session where SCHEMANAME=upper('{$DB_USER}') and SQL_EXEC_START is not null group by inst_id
	</query>
	
	<query time="60" item="zabbix[%1,%2]" nodata="none">
	select inst_id, 'sessions', count(*) Sessions from gv$session where SCHEMANAME=upper('{$DB_USER}') group by inst_id
	</query>
	
	<query time="600" item="zabbix_session_io_log" nodata="none">
	select LISTAGG(sessions_tab,chr(10)) WITHIN GROUP(ORDER BY PCT desc) sessions from (
      select INST_ID||': '||'PCT[R/W/T,MB/s]='||PCT||'['||SESSION_IO_R_MBps||'/'||SESSION_IO_W_MBps||'/'||TOTAL_IO_MBps||'];SQL_(ID/FULL_PLAN_HV)='||SQL_ID||'/'||sql_full_plan_hash_value||';SID='||sid||'#'||SERIAL#||';(SCH/USER)NAME='||SCHEMANAME||'/'||USERNAME||';STATUS='||STATUS||';TYPE='||TYPE||';OSUSER='||OSUSER||';PROGRAM='||REGEXP_REPLACE(PROGRAM,'@.*$','')||'@'||MACHINE||';PROCESS='||PROCESS||';'||DESCRIPTION sessions_tab, PCT 
      from (
        select b.inst_id,b.sid,b.SERIAL#,b.SCHEMANAME,b.OSUSER,b.USERNAME,b.STATUS,b.SQL_ID,b.PROCESS,b.PROGRAM,b.MACHINE,b.TYPE,
          round(100*(sio.SESSION_IO_R+sio.SESSION_IO_W)/fio.TOTAL_IO,2) PCT,round(sio.SESSION_IO_R,2) SESSION_IO_R_MBps,
          round(sio.SESSION_IO_W,2) SESSION_IO_W_MBps,round(fio.TOTAL_IO, 2) TOTAL_IO_MBps,p.DESCRIPTION, sio.sql_full_plan_hash_value 
        from gv$session b, gv$bgprocess p, (
          select inst_id, sum(((DELTA_READ_IO_BYTES/1024/1024)+(DELTA_WRITE_IO_BYTES/1024/1024))/(DELTA_TIME/1000000))/600 total_io 
          from GV$ACTIVE_SESSION_HISTORY where sample_time &gt; sysdate-10/24/60 
          group by inst_id
        ) fio,(
          select inst_id, session_id,sum((DELTA_READ_IO_BYTES/1024/1024)/(DELTA_TIME/1000000))/600 session_io_r, sum((DELTA_WRITE_IO_BYTES/1024/1024)/(DELTA_TIME/1000000))/600 session_io_w, sql_full_plan_hash_value 
          from GV$ACTIVE_SESSION_HISTORY 
          where sample_time &gt; sysdate-10/24/60
          group by inst_id, session_id, sql_full_plan_hash_value
        ) sio 
        where p.paddr(+) = b.paddr and p.inst_id(+)=b.inst_id 
              and sio.session_id = b.sid and sio.inst_id=b.inst_id 
              and fio.inst_id=b.inst_id and b.SCHEMANAME = upper('{$DB_USER}')
        order by PCT desc nulls last
    ) where rownum &lt; 11)
	</query>
	
	<multiquery time="60" items="zabbixsessionioread[%1]|zabbixsessioniowrite[%1]" nodata="none" type="column">
	select ash.inst_id, sum((DELTA_READ_IO_BYTES/(DELTA_TIME/1000000))/60), sum((DELTA_WRITE_IO_BYTES/(DELTA_TIME/1000000))/60)
	from GV$ACTIVE_SESSION_HISTORY ash 
	JOIN dba_users u on username=upper('{$DB_USER}') 
	where sample_time &gt; sysdate - 1/24/60 and u.user_id=ash.USER_ID group by ash.inst_id
	</multiquery>
	
	
	
	</server>
</parms>